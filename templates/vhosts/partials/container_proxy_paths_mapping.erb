<% if @configuration['containers'].is_a?(Hash) && @configuration['containers'].any?{|c,v| v['route'].is_a?(Hash) }
  paths = @configuration['containers'].keys.inject({}) do |res,c|
    Hash(@configuration['containers'][c]['route']).each do |path,port|
      p = path =~ /^\// ? path : "/#{p}"
      if res[p]
        scope.call_function('fail', "Double defined path for #{name} and container #{c} to route")
      end
      res[p] = port
    end
    res
  end
  paths.keys.sort_by{|a| a.length }.reverse.each do |path|
    port,target_path = paths[path].to_s.split('/',2)
    target_path ||= path
    d =  @domain == 'absent' ? @name : @domain
-%>
  ProxyPass <%= path %> unix:<%= @real_path %>/tmp/run/<%= port %>|http://<%= d %><%= target_path %>
  ProxyPassReverse <%= path %> unix:<%= @real_path %>/tmp/run/<%= port %>|http://<%= d %><%= target_path %>
<% end
end -%>
